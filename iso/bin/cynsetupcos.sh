#!/bin/bash
# setup files for cynageOS 
# ekahPruthvi <https://github.com/ekahPruthvi>

set -e

USER="$(cat bob.txt)"

cat <<EOT > /mnt/root/cyn.sh
# @@@@@%%%%%%%%%####********+++++++++++++++++++******########%%%%%%%%%%%%%%%%%%%%%%%%%##%######
# @@@@@@@%%%####************++++++++++++++++++++++******########%%%%%%%%%%%%%%%%%%%%%%%#%######
# @@@@%%%%%%%%####*********++++++++++++++++++++++++*******########%%%#%%%%%%%%%%%%%%%%%%#######
# @@@@%%%%%%#####***********+*+++++++++++++++++++++*++******#*########%%%%%%%%%%%%%%%%%%#######
# @@@@%%%%%%######************+**+**++++++++++*+**++++++*****############%%%%%%%%%%%%%%########
# @@%%%%######******************+++++++++++++++++++++++++++******#########%%#%%%%%##%%%########
# @@%%%########*******************++++++++++++++++++++++++++++++*+****########%%%%%##%%########
# @%%%%%####*************************++++++++++++++++=++++++++++++++**#*########%%%%%#%%%#%%%%%
# %%%%%######***************************+++++++++++++==+++++++=++==+=+++**########%%%%%%%%%%%%%
# %%%%%#######**#**#********************+++++++++++++++++=++===+==+++=+++****#######%%%%%%%%%%%
# %%%%#########*##########*******************************+++++++===-=+++=++****#######%%%%%%%%%
# %%%%#############################****************+*++*******+=-=========+++****#######%%%%%%%
# %%%%##########################*****************+++*++++*+++++*#*=:-=--===++++*****#####%%%%%%
# %%%%##################%%########*****************+***++++++*+******=--======++*****######%%%%
# %%%%#############%%%%%#########*****************++++++=+++++++++++**#+=-=====++*******####%%%
# %%%%########%%%%%%%%%%%%%%########*****************+++++++====+++++++***+-==++++*******###%%%
# %%%%%%%%%%%%%%%%%%%%%%%%###########************+++++=++=+===+++==++++++***+==+++*******###%%%
# %%%%%%%%%%%%%%%%%%%%%%%###############**********+++====++++======+==+++++***++++********##%%%
# %%%%%%%%%%%%%%%%%%%%%%%#######################**+*+++==+==++++++====+++++++***+++********##%%
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#%%#%%%%%%%%%%%%%%%%%%#####****++++++++++++***+++******###%%
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%@%@@@@@@@@@@@@@@@@@@@@@%%%%%#######**++++*++++**++**######%%
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%@@@@@@@@@@@@@@@@@@@@@@%%@@%%%%%%%%%%%%%%##**++++++*****#####%%%
# %%%%%%%%%%%%%%%%%%%%%%%%%%@@@@@@@@@@@@@@@@@@@@@@@#*%==%%%%####%%%%%%%%%%%##*++++++***#####%%%
# %%%%%%%%%%%%%%%%%%%%%%%@@@@@@@@@@@@@@@@@@@@@@@%%#%%%=+%%%%*==++*##%%%%%%%%%%%#*++++***###%%%%
# %%%%%%%%%%%%%%%%%%%%%@@@@@@@@%%%@@@@@@@@@@@@@@@%%%%%=*%%%%#+---==+*#%%%%%%%%%%%%#*++**###%%%%
# %%%%%%%%%%%%%%%%%@@@@@@@@@%%%%%%@@@@@@@@@@%@@@@@@@%%%%%%%%%*=-----=+**##%%%%@@%%%%######%%%%%
# %%%%%%%%%%%%%%%%%@@@@@@@@%%%#%%%@@@@@@@@%%@@@@@%%%%#%@@%%%%*=--::--==++*#%%%%%%@@@%%%%#%%%%%%
# %%%%%%%%%%%%%@@@@@@@@@@@@%%%###%%@@@@@@@@@@@@@%@@@@@@@%%%%%*=-::::---==+*##%%%%%@%%%%%%%%%%%%
# %%%%%%%%@@@@@@@@@@@@@@@%%%%#####%%@@@@@@@@@@%@@@@@@@@%%%%%#+=-::::---==+**##%%%%%%##%%%%%%%%%
# %%%%%%%%%%%@@@@@@@@@@@@@%%%%%%##%%@@@@@@@@@@@@@@@@%%%%%%%%*=--:::----==++*##%#######%%%%%#%%%
# %%%%%%%%%%%%%%@@@@@@@@@@%%%%%%%%%%%@@@@@@%%%%%@@%%%%%%%%#+=-:::-=++*****+**#***#####%%%%####%
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%@@@@@@@@%%%%%%%%%%#+=-+++*******+++**#***##**##%%########
# #%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%################******+*++***+++++*###*******##############
# ###%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%########*#**#*************###**********###############
# #######%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%####%###########*##**########***********###############%
# #######################%%%%%%%%%%%%%%%%%%%##%%%%%###########****************##*******########
# ##############*#************###############%%%######**********************************######%
# #***************************************************++++*+++++++**+*+*****************######%
# ***************+*+++++++++++++++++++++++++++++++++++++++++++++++++******++***********#######%
# ***********+++*+++++++++++++++++++++++++++++++++++++++++++++********++++++++********#######%%
# ******++++++++++++++++++++++++++++++++++++++++++++++**+*********+++++++++++++******######%%%%
# *****+++++++++++++++++++++++++++++++++++++++**++*+******++++++++++++++++++++++****######%%%%%
# ***+++++++++++++=+++++===+++++++++++++++++++++++++++++++++++++++++++++++++++++****######%%%%%
# ****++++++++++++++++++==+++++++=++=+++++++++++++++++++=+++++++++++++++++++++++***######%%%%%%
# *++++++++++++++++++=+==++=========++++==+=++++++++======++=+++===++++++++++++****#####%%%%%%%
# ***++++++++++++++++++==+=====================+================+========+=+++*****#####%%%%%%#
# *****++++++++++++++=++=======================================+========++++++*****####%%%%%###
# ******++++++++++++++=================================================+===++++***####%%%%####*
# ******+++++++++++++++===============================================+==+++++****###%%%#####**
# ******++++++++++++++=================================================+=+++++***###%%%########
# *****+++++++++++++======+==============================-===============+++++**###%%%#########
# ***+*+++++++++++++==+===================================-========-=====+++++**##%%%##########
# ***+++++++++++++++===================================-=-=-===----=====+=+++**##%%%###########
# ****++++++++++++++=====+===========================-=-=-==---==--===++++=+**##%%%%###########
# **++++++++*+++======+=++===============================----=-=--=====++++**##%%%%############

printf"

░▀█▀░█▀▀▄░█▀▀░▀█▀░█▀▀▄░█░░█░░░▀░░█▀▀▄░█▀▀▀
░▒█░░█░▒█░▀▀▄░░█░░█▄▄█░█░░█░░░█▀░█░▒█░█░▀▄
░▄█▄░▀░░▀░▀▀▀░░▀░░▀░░▀░▀▀░▀▀░▀▀▀░▀░░▀░▀▀▀▀

░█▀▀▄░█▀▀░█▀▀█░█░▒█░░▀░░█▀▀▄░█▀▀░█▀▄
░█▄▄▀░█▀▀░█▄▄█░█░▒█░░█▀░█▄▄▀░█▀▀░█░█
░▀░▀▀░▀▀▀░░░░█░░▀▀▀░▀▀▀░▀░▀▀░▀▀▀░▀▀░

░▄▀▀▄░█▀▀▄░▄▀▀▄░█▀▀▀░█▀▀▄░█▀▀▄░█▀▄▀█░█▀▀░░░░░
░█▄▄█░█▄▄▀░█░░█░█░▀▄░█▄▄▀░█▄▄█░█░▀░█░▀▀▄░░░▄▄
░█░░░░▀░▀▀░░▀▀░░▀▀▀▀░▀░▀▀░▀░░▀░▀░░▒▀░▀▀▀░░░▀▀

"

sleep 2s

cp /etc/sudoers /etc/sudo.bak
echo "%wheel ALL=(ALL) NOPASSWD: /usr/bin/pacman" >> /etc/sudoers

if lspci | grep -E -i 'nvidia|geforce'; then
  su - $USER -c 'yay -S --needed --noconfirm nvidia-open nvidia-utils lib32-nvidia-utils' 
elif lspci | grep -E -i 'amd|ati|radeon'; then
  su - $USER -c 'yay -S --needed --noconfirm xf86-video-amdgpu lib32-mesa' 
fi 

su - $USER -c 'yay -S --needed --noconfirm archiso ark base base-devel bc blueman bluez bluez-utils brightnessctl cliphist code cpio cups-pdf dnsmasq dosfstools dunst efibootmgr espeak-ng eza ffmpegthumbs flatpak fuse2 git greetd grimblast-git grub gst-plugin-pipewire gst-plugins-base gtk4-layer-shell hostapd htop hyprland hyprpicker hyprshot i2c-tools imagemagick iw jq kde-cli-tools kdeconnect kitty kvantum kvantum-qt5 libconfig libev libnotify libresprite linux-headers loupe man-db mpv mtools nano nautilus netdiscover network-manager-applet networkmanager noto-fonts-emoji nwg-look oh-my-zsh-git pacman-contrib pam-python pamixer parallel pavucontrol pipewire pipewire-alsa pipewire-audio pipewire-jack pipewire-pulse playerctl pokemon-colorscripts-git polkit-kde-agent pv pyprland qt5-graphicaleffects qt5-imageformats qt5-quickcontrols qt5-quickcontrols2 qt5-wayland qt5ct qt6-virtualkeyboard qt6-wayland qt6ct rpi-imager rustup sddm slurp smassh-bin sox sudo swww system-config-printer systemd tk ttf-bigblueterminal-nerd ttf-heavydata-nerd udiskie usbutils uthash v4l-utils vim zen-browser vte4 wev wf-recorder wget wireplumber xdg-desktop-portal-gtk xdg-desktop-portal-hyprland xf86-video-vesa xorg-bdftopcf xorg-docs xorg-font-util xorg-fonts-100dpi xorg-fonts-75dpi xorg-iceauth xorg-mkfontscale xorg-server-devel xorg-server-xephyr xorg-server-xnest xorg-server-xvfb xorg-sessreg xorg-smproxy xorg-x11perf xorg-xbacklight xorg-xcmsdb xorg-xcursorgen xorg-xdpyinfo xorg-xdriinfo xorg-xev xorg-xgamma xorg-xhost xorg-xinput xorg-xkbevd xorg-xkbutils xorg-xkill xorg-xlsatoms xorg-xlsclients xorg-xmodmap xorg-xpr xorg-xrandr xorg-xrdb xorg-xrefresh xorg-xsetroot xorg-xvinfo xorg-xwd xorg-xwininfo xorg-xwud zen-browser zsh-autosuggestions-git zsh-syntax-highlighting-git zsh-theme-powerlevel10k-git xcb-util-renderutil xcb-util-wm xcb-util-errors wayland wayland-protocols egl-wayland libglvnd vulkan-icd-loader vulkan-headers glslang libdrm libinput libxkbcommon pixman seatd hwdata libdisplay-info libliftoff xorg-xwayland libxkbcommon gtk4 gtk4-layer-shell vte4 mesa'

mv /etc/sudo.bak /etc/sudoers

cat << EOF

░▒█▀▀█░█▀▀░▀█▀░▀█▀░░▀░░█▀▀▄░█▀▀▀
░▒█░▄▄░█▀▀░░█░░░█░░░█▀░█░▒█░█░▀▄
░▒█▄▄▀░▀▀▀░░▀░░░▀░░▀▀▀░▀░░▀░▀▀▀▀

░█▀▄░█░░█░█▀▀▄░█▀▀▄░█▀▀▀░█▀▀░▒█▀▀▀█░▒█▀▀▀█
░█░░░█▄▄█░█░▒█░█▄▄█░█░▀▄░█▀▀░▒█░░▒█░░▀▀▀▄▄
░▀▀▀░▄▄▄▀░▀░░▀░▀░░▀░▀▀▀▀░▀▀▀░▒█▄▄▄█░▒█▄▄▄█

░█▀▀░█▀▄░▄▀▀▄░█▀▀░█░░█░█▀▀░▀█▀░█▀▀░█▀▄▀█
░█▀▀░█░░░█░░█░▀▀▄░█▄▄█░▀▀▄░░█░░█▀▀░█░▀░█
░▀▀▀░▀▀▀░░▀▀░░▀▀▀░▄▄▄▀░▀▀▀░░▀░░▀▀▀░▀░░▒▀

░▒█▀▀▄░█▀▀░█▀▀▄░█▀▄░█░░█░░░░░
░▒█▄▄▀░█▀▀░█▄▄█░█░█░█▄▄█░▄▄░░
░▒█░▒█░▀▀▀░▀░░▀░▀▀░░▄▄▄▀░▀▀░░

EOF

sed -i -E -e "s|^command = .*|command = \"cage -m last -s /usr/bin/octobacillus\"|" "/etc/greetd/config.toml"
systemctl enable greetd.service

cat << EOF

░▒█▀▀▀░░▀░░█▀▀▄░░▀░░█▀▀░█░░░░░▀░░█▀▀▄░█▀▀▀
░▒█▀▀░░░█▀░█░▒█░░█▀░▀▀▄░█▀▀█░░█▀░█░▒█░█░▀▄
░▒█░░░░▀▀▀░▀░░▀░▀▀▀░▀▀▀░▀░░▀░▀▀▀░▀░░▀░▀▀▀▀

░░░▀▀█▀▀░█░░░░█▀▀░█▀▄▀█░░▀░░█▀▀▄░█▀▀▀░░░░░░░
░░░░▒█░░░█▀▀█░█▀▀░█░▀░█░░█▀░█░▒█░█░▀▄░░░▄▄░░
░░░░▒█░░░▀░░▀░▀▀▀░▀░░▒▀░▀▀▀░▀░░▀░▀▀▀▀░░░▀▀░░

EOF

sleep 1s
pidof cap | xargs kill -38

# copy confis

echo "Unmounting and Finishing up"
umount -lR /mnt
EOT

chmod +x /mnt/root/cyn.sh
echo "Entering chroot to complete cynageOS setup..."
arch-chroot /mnt /root/cyn.sh

echo "Cleaning cynageOS setup script..."
rm /mnt/root/cyn.sh

pidof cap | xargs kill -39